#!/bin/sh
# preinst script for gerrit
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
       install|upgrade)
     
	# If the package has default file it could be sourced, so that
	# the local admin can overwrite the defaults
     
	[ -f "/etc/default/gerrit" ] && . /etc/default/gerrit
     
	# Sane defaults:
     
	[ -z "$USER_HOME" ] && USER_HOME=/home/gerrit
	[ -z "$USER_NAME" ] && USER_NAME=gerrit
	[ -z "$USER_FULLNAME" ] && USER_FULLNAME="Gerrit Daemon User"
	[ -z "$USER_GROUP" ] && USER_GROUP=gerrit
     
	# Groups that the user will be added to, if undefined, then none.
	ADDGROUP=""
     
	# create user to avoid running server as root
	# 1. create group if not existing
	if ! getent group | grep -q "^$USER_GROUP:" ; then
		echo -n "Adding group $USER_GROUP.."
		addgroup --quiet --system $USER_GROUP 2>/dev/null || true
		echo "..done"
	fi
	# 2. create homedir if not existing
	test -d $USER_HOME || mkdir $USER_HOME
	# 3. create user if not existing
	if ! getent passwd | grep -q "^$USER_NAME:"; then
		echo -n "Adding system user $USER_NAME.."
		adduser --quiet \
			 --system \
			--ingroup $USER_GROUP \
			--no-create-home \
			--disabled-password \
			$USER_NAME 2>/dev/null || true
		echo "..done"
	fi
       # 4. adjust passwd entry
	usermod -c "$USER_FULLNAME" \
		-d $USER_HOME   \
		-g $USER_GROUP  \
                  $USER_NAME
	# 5. adjust file and directory permissions
	if ! dpkg-statoverride --list $USER_HOME >/dev/null
	then
		chown -R $USER_NAME:${USER_GROUP} $USER_HOME
		chmod u=rwx,g=rxs,o= $USER_HOME
	fi
	# 6. Add the user to the ADDGROUP group
	if test -n "$ADDGROUP"
	then
		if ! groups $USER_NAME | cut -d: -f2 | \
		grep -qw $ADDGROUP; then
			adduser $USER_NAME $ADDGROUP
		fi
	fi
	;;
	abort-upgrade)
	;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
